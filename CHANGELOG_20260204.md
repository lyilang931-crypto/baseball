# 野球クイズアプリ 改善レポート (2026-02-04)

## 変更点要約

### 1. バグ修正（最優先）

#### 1.1 「◯人中◯人正解」表示の破綻を修正
**ファイル**: `app/components/ResultView.tsx`

- **問題**: 分母・分子が逆になっていた（「正解数人中回答数人正解」と表示）
- **修正内容**:
  - 「{回答数}人中{正解数}人正解」の正しい順序に修正
  - 表示閾値を5件→10件に変更（初期ユーザーが少ない間は非表示）
  - 集計中の表示に回答数を追加（「統計集計中（X人回答）」）
  - 未ロード時の「集計中」表示を削除

#### 1.2 タイムアウト後の自動不正解バグを修正
**ファイル**: `app/page.tsx`

- **問題**: 次の問題に遷移時、タイマーリセット前にタイムアウト判定が走り、連続で不正解になる可能性があった
- **修正内容**:
  - `clearTimer()` を先に呼び出し（二重タイムアウト防止）
  - `answerLogSentForIndex.current` を遷移時にリセット
  - `setSecondsLeft(TIMER_SECONDS)` を `setCurrentIndex` より前に実行
  - タイムアウト判定に `timerId === null` チェックを追加（遷移中の誤発火防止）

#### 1.3 questionId/UUID不整合の防止
**ファイル**: `src/data/questions.ts`

- **問題**: id と QUESTION_UUIDS のインデックスが不一致で、問題追加時に壊れやすい構造
- **修正内容**:
  - 問題品質ルールとUUID管理ルールをコメントで明記
  - `validateQuestionIds()` 関数を追加（重複チェック、出典URL検証、正解存在確認）
  - `TOTAL_QUESTIONS` 定数をエクスポート

---

### 2. UX改善

#### 2.1 カウント表記の統一
**ファイル**: `src/utils/countDisplay.ts`

- **変更**: 「XボールYストライク」→「XボールYストライクカウント」に統一
- 「カウントカウント」の重複防止ロジックを追加

---

### 3. 問題品質ルールの導入
**ファイル**: `src/data/questions.ts` 冒頭

以下のルールをコード内コメントとして定義:

```
【出典ルール】
- Baseball Savant / Statcast
- MLB公式 / NPB公式
- Baseball-Reference

【問題設計ルール】
- 「誰でも分かる正解」は禁止
- 日本人スター問題でも TOP バイアスは避ける
- 外れ選択肢も「一理ある」ものにする

【出題形式ルール】
- 球種問題 → 球種を直接選ばせる
- 成績系問題 → 順位レンジ当てはOK
```

---

### 4. Google Play 収益化の下準備
**新規ファイル**: `src/lib/monetization.ts`

#### 4.1 無料版制限
- `FREE_DAILY_SESSIONS = 3` (1日3回)
- `QUESTIONS_PER_SESSION = 5` (1回5問)
- 広告視聴で追加セッション獲得（将来実装）

#### 4.2 広告ポイントの設計
| タイミング | 広告タイプ | 頻度/報酬 |
|-----------|----------|----------|
| リザルト画面 | インタースティシャル | 2セッションに1回 |
| デイリーボーナス | リワード | 追加1セッション |
| スタート画面 | バナー | 常時（控えめに） |
| 追加プレイ獲得 | リワード | 制限リセット |

#### 4.3 将来課金用フラグ

| プラン | 価格 | 機能 |
|-------|------|------|
| 月額ベーシック | ¥480 | 広告非表示, 無制限プレイ |
| 月額プロ | ¥980 | 上記 + 詳細分析 |
| 年額プロ | ¥7,800 | 月額プロと同等（2ヶ月分お得） |

---

## 修正ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `app/components/ResultView.tsx` | 正解率表示の修正 |
| `app/components/StartView.tsx` | 広告ボーナスUI追加 |
| `app/components/FinalResultView.tsx` | 広告ポイントコメント追加 |
| `app/page.tsx` | タイムアウトバグ修正 |
| `src/data/questions.ts` | 品質ルール・バリデーション追加 |
| `src/utils/countDisplay.ts` | カウント表記統一 |
| `src/lib/monetization.ts` | 新規（収益化基盤） |
| `src/lib/index.ts` | monetizationエクスポート追加 |

---

## 次のステップ (Google Play 向け TODO)

別ファイル `GOOGLE_PLAY_TODO.md` を参照
